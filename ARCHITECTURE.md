# Application Architecture

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Browser                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚             React Frontend (Port 5173)                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚   Pages      â”‚  â”‚  Components  â”‚  â”‚     Context      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Dashboard  â”‚  â”‚ - ChildCard  â”‚  â”‚ - Auth           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Tasks      â”‚  â”‚ - Modal      â”‚  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Rewards    â”‚  â”‚ - Layout     â”‚  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Family     â”‚  â”‚              â”‚  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Detail     â”‚  â”‚              â”‚  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚         â”‚                                                   â”‚ â”‚
â”‚  â”‚         â”‚ API Calls                                         â”‚ â”‚
â”‚  â”‚         â–¼                                                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚              API Client Layer                         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  auth, families, children, tasks, rewards, activity  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTP/JSON + Cookies
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           TypeScript Express Backend (Port 3000)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     Middleware                              â”‚ â”‚
â”‚  â”‚  - CORS                                                     â”‚ â”‚
â”‚  â”‚  - Cookie Parser                                            â”‚ â”‚
â”‚  â”‚  - authenticateToken (JWT validation)                       â”‚ â”‚
â”‚  â”‚  - attachFamilyInfo (loads user's family context)           â”‚ â”‚
â”‚  â”‚  - requireFamily (ensures user has a family)                â”‚ â”‚
â”‚  â”‚  - requireFamilyAdmin (admin-only endpoints)                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚                                     â”‚
â”‚                            â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                       Routes                                â”‚ â”‚
â”‚  â”‚  /api/auth       â†’ authController                           â”‚ â”‚
â”‚  â”‚  /api/families   â†’ familyController                         â”‚ â”‚
â”‚  â”‚  /api/children   â†’ childrenController                       â”‚ â”‚
â”‚  â”‚  /api/tasks      â†’ tasksController                          â”‚ â”‚
â”‚  â”‚  /api/rewards    â†’ rewardsController                        â”‚ â”‚
â”‚  â”‚  /api/children   â†’ activityController (activity & stats)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚                                     â”‚
â”‚                            â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Controllers                              â”‚ â”‚
â”‚  â”‚  - Business Logic                                           â”‚ â”‚
â”‚  â”‚  - Input Validation                                         â”‚ â”‚
â”‚  â”‚  - Family-scoped queries (using req.familyId)               â”‚ â”‚
â”‚  â”‚  - Response Formatting                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚                                     â”‚
â”‚                            â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                Database Wrapper                             â”‚ â”‚
â”‚  â”‚  - prepare<T>() for typed queries                           â”‚ â”‚
â”‚  â”‚  - run(), get(), all() methods                              â”‚ â”‚
â”‚  â”‚  - Transaction support                                      â”‚ â”‚
â”‚  â”‚  - Test database injection                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SQLite Database (sql.js)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  users   â”‚  â”‚ families â”‚  â”‚ family_members â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ children â”‚  â”‚  tasks   â”‚  â”‚ rewards  â”‚  â”‚ completions  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚ redemptions â”‚  â”‚  point_adjusts   â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Monorepo Structure

```
rewards/
â”œâ”€â”€ package.json              # Workspace root with npm workspaces
â”œâ”€â”€ packages/
â”‚   â””â”€â”€ shared/               # @rewards/shared - TypeScript types
â”‚       â”œâ”€â”€ package.json
â”‚       â”œâ”€â”€ tsconfig.json
â”‚       â””â”€â”€ src/
â”‚           â”œâ”€â”€ index.ts      # Main exports
â”‚           â”œâ”€â”€ enums.ts      # FamilyRole, ActivityType
â”‚           â”œâ”€â”€ entities/     # Entity type definitions
â”‚           â”‚   â”œâ”€â”€ user.ts
â”‚           â”‚   â”œâ”€â”€ family.ts
â”‚           â”‚   â”œâ”€â”€ child.ts
â”‚           â”‚   â”œâ”€â”€ task.ts
â”‚           â”‚   â””â”€â”€ reward.ts
â”‚           â””â”€â”€ api/          # API request/response types
â”‚               â”œâ”€â”€ auth.ts
â”‚               â”œâ”€â”€ families.ts
â”‚               â”œâ”€â”€ children.ts
â”‚               â”œâ”€â”€ tasks.ts
â”‚               â”œâ”€â”€ rewards.ts
â”‚               â””â”€â”€ activity.ts
â”œâ”€â”€ server/                   # TypeScript Express server
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ vitest.config.ts
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ types/            # TypeScript declarations
â”‚       â”‚   â”œâ”€â”€ express.d.ts  # Express Request augmentation
â”‚       â”‚   â”œâ”€â”€ database.ts   # Database wrapper types
â”‚       â”‚   â””â”€â”€ sql.js.d.ts   # sql.js type declarations
â”‚       â”œâ”€â”€ db/
â”‚       â”‚   â”œâ”€â”€ schema.sql
â”‚       â”‚   â”œâ”€â”€ init.ts
â”‚       â”‚   â””â”€â”€ wrapper.ts
â”‚       â”œâ”€â”€ middleware/
â”‚       â”‚   â”œâ”€â”€ auth.ts
â”‚       â”‚   â””â”€â”€ familyAuth.ts
â”‚       â”œâ”€â”€ controllers/
â”‚       â”‚   â”œâ”€â”€ authController.ts
â”‚       â”‚   â”œâ”€â”€ familyController.ts
â”‚       â”‚   â”œâ”€â”€ childrenController.ts
â”‚       â”‚   â”œâ”€â”€ tasksController.ts
â”‚       â”‚   â”œâ”€â”€ rewardsController.ts
â”‚       â”‚   â””â”€â”€ activityController.ts
â”‚       â”œâ”€â”€ routes/
â”‚       â”‚   â”œâ”€â”€ auth.ts
â”‚       â”‚   â”œâ”€â”€ families.ts
â”‚       â”‚   â”œâ”€â”€ children.ts
â”‚       â”‚   â”œâ”€â”€ tasks.ts
â”‚       â”‚   â”œâ”€â”€ rewards.ts
â”‚       â”‚   â””â”€â”€ activity.ts
â”‚       â”œâ”€â”€ utils/
â”‚       â”‚   â””â”€â”€ inviteCode.ts
â”‚       â”œâ”€â”€ app.ts
â”‚       â””â”€â”€ server.ts
â””â”€â”€ client/                   # React frontend
    â””â”€â”€ src/
        â”œâ”€â”€ api/
        â”œâ”€â”€ components/
        â”œâ”€â”€ context/
        â””â”€â”€ pages/
```

## Database Relationships

```
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚    users    â”‚
                            â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
                            â”‚ id          â”‚
                            â”‚ email       â”‚
                            â”‚ password    â”‚
                            â”‚ name        â”‚
                            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â”‚ 1:1 (via family_members)
                                   â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  family_members  â”‚
                            â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
                            â”‚ id               â”‚
                            â”‚ family_id (FK)   â”‚â—„â”€â”€â”
                            â”‚ user_id (FK)     â”‚   â”‚
                            â”‚ role (admin/     â”‚   â”‚
                            â”‚       member)    â”‚   â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                                   â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
                            â”‚  families   â”‚        â”‚
                            â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚        â”‚
                            â”‚ id          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ name        â”‚
                            â”‚ invite_code â”‚
                            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                        â”‚                        â”‚
          â–¼                        â–¼                        â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   children   â”‚         â”‚  tasks   â”‚            â”‚ rewards  â”‚
   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚            â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
   â”‚ id           â”‚         â”‚ id       â”‚            â”‚ id       â”‚
   â”‚ family_id    â”‚         â”‚ family_idâ”‚            â”‚ family_idâ”‚
   â”‚ created_by   â”‚         â”‚ created_byâ”‚           â”‚ created_byâ”‚
   â”‚ name         â”‚         â”‚ name     â”‚            â”‚ name     â”‚
   â”‚ current_pts  â”‚         â”‚ points   â”‚            â”‚ cost     â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                       â”‚
          â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”                   â”‚
          â”‚         â”‚                â”‚                   â”‚
          â–¼         â–¼                â”‚                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ point_adjust   â”‚ â”‚ completions    â”‚â”‚          â”‚  redemptions   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚â”‚          â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ child_id (FK)  â”‚ â”‚ task_id (FK)   â”‚â”‚          â”‚ reward_id (FK) â”‚
â”‚ amount         â”‚ â”‚ child_id (FK)  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ child_id (FK)  â”‚
â”‚ reason         â”‚ â”‚ points_earned  â”‚           â”‚ points_spent   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Family-Based Data Isolation

All data queries are scoped by `family_id`:

```typescript
// Middleware attaches family info to every authenticated request
export const attachFamilyInfo = (req, res, next) => {
  const membership = db.prepare<FamilyMembershipRow>(
    `SELECT fm.family_id, fm.role, f.name as family_name
     FROM family_members fm
     JOIN families f ON fm.family_id = f.id
     WHERE fm.user_id = ?`
  ).get(req.userId);

  req.familyId = membership?.family_id ?? null;
  req.familyRole = membership?.role ?? null;
  next();
};

// Controllers use req.familyId for all queries
const children = db.prepare<Child>(
  'SELECT * FROM children WHERE family_id = ?'
).all(req.familyId);
```

## Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Initial Page Load                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  AuthContext useEffect      â”‚
              â”‚  GET /api/auth/me           â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚
                â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ JWT Valid     â”‚        â”‚ No JWT       â”‚
        â”‚ Return user + â”‚        â”‚ Return 401   â”‚
        â”‚ family info   â”‚        â”‚              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                       â”‚
                â–¼                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Has family?   â”‚        â”‚ Redirect to  â”‚
        â”‚               â”‚        â”‚ /login       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚
        â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Yes: Show     â”‚ â”‚ No: Show     â”‚
â”‚ Dashboard     â”‚ â”‚ Family Setup â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow: Complete Task

```
User clicks "Complete" â†’ TasksPage â†’ Modal opens
    â†“
Select child + optional notes â†’ Submit form
    â†“
POST /api/tasks/:id/complete â†’ tasksController.completeTask()
    â†“
Middleware chain:
  1. authenticateToken â†’ sets req.userId
  2. attachFamilyInfo â†’ sets req.familyId, req.familyRole
  3. requireFamily â†’ ensures user has a family
    â†“
Controller validates:
  - Task exists AND belongs to req.familyId
  - Child exists AND belongs to req.familyId
    â†“
Transaction:
  1. INSERT into task_completions
  2. UPDATE children.current_points (+points)
  3. Save database
    â†“
Return updated child â†’ Refresh UI
```

## Type Safety Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    @rewards/shared                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Entities   â”‚  â”‚   API Types  â”‚  â”‚     Enums        â”‚   â”‚
â”‚  â”‚  - User      â”‚  â”‚  - Request   â”‚  â”‚  - FamilyRole    â”‚   â”‚
â”‚  â”‚  - Family    â”‚  â”‚  - Response  â”‚  â”‚  - ActivityType  â”‚   â”‚
â”‚  â”‚  - Child     â”‚  â”‚              â”‚  â”‚                  â”‚   â”‚
â”‚  â”‚  - Task      â”‚  â”‚              â”‚  â”‚                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                   â”‚
          â–¼                 â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Server                                â”‚
â”‚  import type { Child, Task } from '@rewards/shared';         â”‚
â”‚  import type { FamilyRole } from '@rewards/shared';          â”‚
â”‚                                                              â”‚
â”‚  // Typed database queries                                   â”‚
â”‚  const child = db.prepare<Child>(                            â”‚
â”‚    'SELECT * FROM children WHERE id = ?'                     â”‚
â”‚  ).get(id);                                                  â”‚
â”‚                                                              â”‚
â”‚  // Typed request augmentation                               â”‚
â”‚  interface Request {                                         â”‚
â”‚    userId?: number;                                          â”‚
â”‚    familyId?: number | null;                                 â”‚
â”‚    familyRole?: FamilyRole | null;                           â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Client                                â”‚
â”‚  import type { Child } from '@rewards/shared';               â”‚
â”‚                                                              â”‚
â”‚  const [children, setChildren] = useState<Child[]>([]);      â”‚
â”‚                                                              â”‚
â”‚  // Type-safe API responses                                  â”‚
â”‚  const response = await api.getChildren();                   â”‚
â”‚  setChildren(response.children);                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Testing Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Test Environment                          â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚               vitest.config.ts                          â”‚ â”‚
â”‚  â”‚  - setupFiles: ['./tests/setup.ts']                     â”‚ â”‚
â”‚  â”‚  - environment: 'node'                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚                                 â”‚
â”‚                            â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                 tests/setup.ts                          â”‚ â”‚
â”‚  â”‚  - Initialize sql.js                                    â”‚ â”‚
â”‚  â”‚  - beforeEach: Create fresh in-memory database          â”‚ â”‚
â”‚  â”‚  - Inject test DB via setTestDb()                       â”‚ â”‚
â”‚  â”‚  - afterAll: Clean up                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚                                 â”‚
â”‚                            â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                 tests/helpers.ts                        â”‚ â”‚
â”‚  â”‚  - getApp() â†’ creates Express app                       â”‚ â”‚
â”‚  â”‚  - registerUser() â†’ register + get cookie               â”‚ â”‚
â”‚  â”‚  - setupUserWithFamily() â†’ user + family in one step    â”‚ â”‚
â”‚  â”‚  - createChild(), createTask(), createReward()          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚                                 â”‚
â”‚                            â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Test Files                           â”‚ â”‚
â”‚  â”‚  - auth.test.ts (15 tests)                              â”‚ â”‚
â”‚  â”‚  - families.test.ts (28 tests)                          â”‚ â”‚
â”‚  â”‚  - children.test.ts (21 tests)                          â”‚ â”‚
â”‚  â”‚  - tasks.test.ts (20 tests)                             â”‚ â”‚
â”‚  â”‚  - rewards.test.ts (21 tests)                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Security Layers

```
1. Frontend
   â”œâ”€â”€ HTTP-only cookies (no JS access to JWT)
   â”œâ”€â”€ CSRF protection via SameSite cookie attribute
   â””â”€â”€ Client-side route protection + family guard

2. Network
   â”œâ”€â”€ CORS configuration (specific origin)
   â””â”€â”€ Secure cookie flag (production)

3. Backend Middleware
   â”œâ”€â”€ authenticateToken - JWT verification
   â”œâ”€â”€ attachFamilyInfo - Load family context
   â”œâ”€â”€ requireFamily - Block users without family
   â””â”€â”€ requireFamilyAdmin - Admin-only endpoints

4. Database
   â”œâ”€â”€ Parameterized queries (SQL injection prevention)
   â”œâ”€â”€ Foreign key constraints with CASCADE
   â”œâ”€â”€ Family-based data isolation (all queries scoped by family_id)
   â””â”€â”€ User data never crosses family boundaries

5. Authentication
   â”œâ”€â”€ bcrypt password hashing (10 rounds)
   â”œâ”€â”€ Token expiration (7 days)
   â””â”€â”€ Invite code validation (8 chars, specific charset)
```

## API Request/Response Examples

### POST /api/auth/register
**Request:**
```json
{
  "email": "parent@example.com",
  "password": "securepass123",
  "name": "John Doe"
}
```

**Response:**
```json
{
  "user": {
    "id": 1,
    "email": "parent@example.com",
    "name": "John Doe"
  }
}
```
**Cookie Set:** `token=eyJhbGc...` (HTTP-only)

### POST /api/families
**Request:**
```json
{
  "name": "Smith Family"
}
```

**Response:**
```json
{
  "family": {
    "id": 1,
    "name": "Smith Family",
    "invite_code": "ABCD2345",
    "created_at": "2026-01-31T..."
  },
  "role": "admin"
}
```

### POST /api/tasks/5/complete
**Request:**
```json
{
  "child_id": 2,
  "notes": "Great job!"
}
```

**Response:**
```json
{
  "message": "Task completed successfully",
  "child": {
    "id": 2,
    "name": "Alice",
    "current_points": 45
  },
  "points_earned": 15
}
```

### GET /api/children/2/stats
**Response:**
```json
{
  "stats": {
    "totalTasksCompleted": 12,
    "totalPointsEarned": 180,
    "totalRewardsRedeemed": 3,
    "totalPointsSpent": 135,
    "currentPoints": 45
  },
  "pointsOverTime": [
    { "date": "2026-01-20", "points": 25 },
    { "date": "2026-01-21", "points": 30 }
  ],
  "tasksByCategory": [
    { "category": "Chores", "count": 7 },
    { "category": "Homework", "count": 5 }
  ],
  "badges": [
    { "name": "First 100 Points", "icon": "ğŸŒŸ" },
    { "name": "10 Tasks Complete", "icon": "âœ…" }
  ]
}
```
